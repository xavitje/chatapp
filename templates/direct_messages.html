<!DOCTYPE html>
<html lang="nl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directe Berichten - FastAPI Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Load theme before anything else
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
    </script>
    <script src="/static/theme-toggle.js"></script>
    <script src="/static/notifications.js"></script>
    <script src="/static/emoji-picker.js"></script>
    <script src="/static/typing-indicator.js"></script>
    <script src="/static/crypto.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1946230957475430"
     crossorigin="anonymous"></script>
    <style>
        /* Theme Variables */
        [data-theme="light"] body {
            background-color: #f3f4f6 !important;
            color: #111827 !important;
        }

        [data-theme="light"] .bg-gray-900 {
            background-color: #f3f4f6 !important;
        }

        [data-theme="light"] .bg-gray-800 {
            background-color: #ffffff !important;
            border: 1px solid #e5e7eb;
        }

        [data-theme="light"] .bg-gray-700 {
            background-color: #f9fafb !important;
            color: #111827 !important;
        }

        [data-theme="light"] .text-gray-100 {
            color: #111827 !important;
        }

        [data-theme="light"] .text-gray-400 {
            color: #6b7280 !important;
        }

        [data-theme="light"] .border-gray-700 {
            border-color: #e5e7eb !important;
        }

        .chat-area::-webkit-scrollbar {
            width: 8px;
        }
        .chat-area::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        .chat-area {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 transparent;
        }

        [data-theme="light"] .chat-area::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex">

    <!-- Sidebar -->
    <div class="w-64 bg-gray-800 p-4 flex-shrink-0 flex flex-col">
        <h2 class="text-xl font-bold mb-6 text-indigo-400">Navigatie</h2>
        <div class="flex-grow">
            <h3 class="text-sm font-semibold text-gray-400 mb-2">CHAT KAMERS</h3>
            <ul id="room-list" class="space-y-2 mb-6">
                <!-- Rooms will be loaded dynamically -->
            </ul>
            <ul class="space-y-2 mb-6">
                <li>
                    <a href="/direct-messages" class="block p-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 font-semibold transition duration-150">üí¨ Directe Berichten</a>
                </li>
            </ul>
            <h3 class="text-sm font-semibold text-gray-400 mb-2">CALL ROOMS</h3>
            <ul id="call-rooms-list" class="space-y-2 mb-6">
                <!-- Call rooms will be populated here -->
            </ul>
            <h3 class="text-sm font-semibold text-gray-400 mb-2">ONLINE GEBRUIKERS</h3>
            <ul id="online-users-list" class="space-y-2 mb-6">
                <!-- Online users will be populated here -->
            </ul>
        </div>
        <div class="mt-auto pt-4 border-t border-gray-700">
            <div class="flex items-center space-x-2">
                <img id="user-avatar" src="/static/default-avatar.svg" class="w-8 h-8 rounded-full" alt="Avatar">
                <p class="text-sm font-semibold">Ingelogd als: <span id="username-display" class="text-indigo-400">Gast</span></p>
            </div>
        </div>
    </div>

    <!-- Users List -->
    <div class="w-64 bg-gray-800 border-l border-gray-700 p-4 flex-shrink-0">
        <h2 class="text-xl font-bold mb-4 text-indigo-400">Gebruikers</h2>
        <div id="users-list" class="space-y-2">
            <!-- User list will be populated here -->
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-grow flex flex-col">
        <header class="p-4 bg-gray-800 shadow-md flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">
                <span id="chat-with-user">Selecteer een gebruiker om te chatten</span>
            </h1>
            <div class="flex items-center space-x-3">
                <button onclick="openCreateRoomModal()" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition" title="Kamer aanmaken">‚ûï</button>
                <span id="status" class="text-sm text-green-500">Verbonden</span>
                <button onclick="openSettingsModal()" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition" title="Instellingen">‚öôÔ∏è</button>
            </div>
        </header>

        <div id="messages" class="chat-area flex-grow p-4 space-y-4 overflow-y-auto">
            <div class="text-center text-gray-500 italic">Selecteer een gebruiker om de conversatie te starten</div>
        </div>

        <div id="message-form-container" class="p-4 bg-gray-800 border-t border-gray-700 hidden">
            <form id="message-form" class="flex space-x-3">
                <button
                    type="button"
                    id="emoji-btn"
                    class="p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition text-2xl"
                    title="Emoji toevoegen"
                >
                    üòÄ
                </button>
                <input
                    type="text"
                    id="message-input"
                    placeholder="Typ een bericht..."
                    class="flex-grow p-3 rounded-lg bg-gray-700 text-white border border-gray-700 focus:outline-none focus:border-indigo-500"
                    autocomplete="off"
                >
                <button
                    type="submit"
                    class="p-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-150"
                >
                    Verzenden
                </button>
            </form>
        </div>
    </div>

    <script>
        // Check Authentication
        const token = localStorage.getItem('access_token');
        const currentUsername = localStorage.getItem('username');

        if (!token) {
            window.location.href = '/login';
        }

        if (currentUsername) {
            document.getElementById('username-display').textContent = currentUsername;
        }

        let selectedUser = null;
        let refreshInterval = null;

        // DOM Elements
        const usersListContainer = document.getElementById('users-list');
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messageFormContainer = document.getElementById('message-form-container');
        const chatWithUserElement = document.getElementById('chat-with-user');

        // Load rooms
        async function loadRooms() {
            try {
                const response = await fetch('/api/rooms', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const rooms = await response.json();
                    const roomList = document.getElementById('room-list');

                    if (!roomList) {
                        console.error('Room list element not found');
                        return;
                    }

                    roomList.innerHTML = '';

                    if (rooms.length === 0) {
                        const li = document.createElement('li');
                        li.className = 'text-gray-500 text-sm italic p-2';
                        li.textContent = 'Geen rooms beschikbaar';
                        roomList.appendChild(li);
                    } else {
                        rooms.forEach(room => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = `/chat/${room.slug}`;
                            a.className = 'block p-2 rounded-lg hover:bg-gray-700 transition duration-150';
                            a.textContent = `# ${room.name}`;
                            li.appendChild(a);
                            roomList.appendChild(li);
                        });
                    }
                    console.log(`Loaded ${rooms.length} rooms`);
                } else {
                    console.error('Failed to load rooms:', response.status);
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    const users = await response.json();
                    usersListContainer.innerHTML = '';

                    users.forEach(user => {
                        if (user.username !== currentUsername) {
                            const userDiv = document.createElement('div');
                            userDiv.className = 'p-2 rounded-lg hover:bg-gray-700 cursor-pointer transition duration-150';
                            userDiv.textContent = user.username;
                            userDiv.onclick = () => selectUser(user.username);
                            usersListContainer.appendChild(userDiv);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Select a user
        function selectUser(username) {
            selectedUser = username;
            chatWithUserElement.textContent = `Chat met: ${username}`;
            messageFormContainer.classList.remove('hidden');

            // Highlight selected user
            Array.from(usersListContainer.children).forEach(div => {
                if (div.textContent === username) {
                    div.classList.add('bg-indigo-600');
                } else {
                    div.classList.remove('bg-indigo-600');
                }
            });

            loadConversation(username);

            // Start auto-refresh
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(() => loadConversation(username), 3000);
        }

        // Load conversation with selected user
        async function loadConversation(username) {
            try {
                const response = await fetch(`/api/direct-messages/${username}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const messages = await response.json();
                    messagesContainer.innerHTML = '';

                    if (messages.length === 0) {
                        messagesContainer.innerHTML = '<div class="text-center text-gray-500 italic">Nog geen berichten. Start de conversatie!</div>';
                    } else {
                        for (const msg of messages) {
                            const messageDiv = document.createElement('div');
                            const isSent = msg.sender_username === currentUsername;

                            messageDiv.className = `p-3 rounded-lg shadow-md max-w-lg ${
                                isSent
                                    ? 'bg-indigo-600 self-end ml-auto'
                                    : 'bg-gray-700 self-start'
                            }`;

                            const senderSpan = document.createElement('span');
                            senderSpan.className = 'font-bold text-sm';
                            senderSpan.textContent = isSent ? 'Jij' : msg.sender_username;

                            const timeSpan = document.createElement('span');
                            timeSpan.className = 'text-xs text-gray-400 ml-2';
                            timeSpan.textContent = new Date(msg.timestamp).toLocaleTimeString();

                            const contentP = document.createElement('p');
                            contentP.className = 'mt-1';

                            // Try to decrypt if encrypted
                            let displayContent = msg.content;
                            try {
                                const parsed = JSON.parse(msg.content);
                                if (parsed.encrypted && window.crypto && crypto) {
                                    // This is an encrypted message
                                    displayContent = await crypto.decryptMessage(parsed);
                                    // Add lock icon to show it was encrypted
                                    const lockIcon = document.createElement('span');
                                    lockIcon.textContent = 'üîí ';
                                    lockIcon.className = 'text-xs';
                                    lockIcon.title = 'End-to-end encrypted';
                                    contentP.appendChild(lockIcon);
                                }
                            } catch (e) {
                                // Not encrypted or parse failed, show as plain text
                            }

                            contentP.appendChild(document.createTextNode(displayContent));

                            messageDiv.appendChild(senderSpan);
                            messageDiv.appendChild(timeSpan);
                            messageDiv.appendChild(contentP);
                            messagesContainer.appendChild(messageDiv);
                        }
                    }

                    scrollToBottom();
                } else if (response.status === 401) {
                    // Token expired
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('username');
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        // Send message
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedUser || !messageInput.value.trim()) {
                return;
            }

            try {
                let contentToSend = messageInput.value.trim();

                // Try to encrypt if crypto is available and user has public key
                if (window.crypto && crypto) {
                    try {
                        // Get recipient's public key
                        const keyResponse = await fetch(`/api/profile/${selectedUser}/public-key`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (keyResponse.ok) {
                            const keyData = await keyResponse.json();
                            // Encrypt with hybrid encryption
                            const encrypted = await crypto.encryptMessage(contentToSend, keyData.public_key);
                            // Mark as encrypted and store as JSON
                            contentToSend = JSON.stringify({
                                encrypted: true,
                                ...encrypted
                            });
                            console.log('‚úÖ Message encrypted with E2E encryption');
                        } else {
                            console.log('‚ö†Ô∏è Recipient has no public key, sending unencrypted');
                        }
                    } catch (encryptError) {
                        console.error('Encryption failed, sending unencrypted:', encryptError);
                    }
                }

                const response = await fetch('/api/direct-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        receiver_username: selectedUser,
                        content: contentToSend
                    })
                });

                if (response.ok) {
                    messageInput.value = '';
                    loadConversation(selectedUser);
                } else if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('username');
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        });

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('username');
            window.location.href = '/login';
        }

        async function loadUserProfile() {
            try {
                const response = await fetch('/api/profile/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const profile = await response.json();
                    document.getElementById('user-avatar').src = profile.avatar_url;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Initialize E2E Encryption
        let crypto = null;
        async function initializeE2EEncryption() {
            if (typeof E2ECrypto === 'undefined') {
                console.log('E2E encryption not available, skipping');
                return;
            }

            try {
                crypto = new E2ECrypto();

                // Try to load existing keys
                const hasExistingKey = await crypto.loadPrivateKey();

                if (!hasExistingKey) {
                    console.log('Generating new encryption keys...');
                    const publicKey = await crypto.generateKeyPair();

                    // Store public key on server
                    try {
                        await fetch('/api/profile/public-key', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ public_key: publicKey })
                        });
                        console.log('‚úÖ E2E encryption keys generated and stored');
                    } catch (error) {
                        console.error('Failed to store public key:', error);
                    }
                } else {
                    console.log('‚úÖ E2E encryption keys loaded');
                }
            } catch (error) {
                console.error('E2E encryption initialization failed:', error);
                console.log('Continuing without E2E encryption');
            }
        }

        // Load call rooms
        async function loadCallRooms() {
            try {
                const response = await fetch('/api/call-rooms', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const callRooms = await response.json();
                    renderCallRoomsList(callRooms);
                }
            } catch (error) {
                console.error('Error loading call rooms:', error);
            }
        }

        function renderCallRoomsList(callRooms) {
            const callRoomsList = document.getElementById('call-rooms-list');
            if (!callRoomsList) return;

            callRoomsList.innerHTML = '';

            if (callRooms.length === 0) {
                const emptyLi = document.createElement('li');
                emptyLi.className = 'text-sm text-gray-500 italic px-2';
                emptyLi.textContent = 'Geen call rooms beschikbaar';
                callRoomsList.appendChild(emptyLi);
                return;
            }

            callRooms.forEach(room => {
                const li = document.createElement('li');
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-700 transition duration-150';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'flex items-center space-x-2 flex-1';

                const icon = document.createElement('span');
                icon.textContent = room.is_public ? 'üîä' : 'üîí';

                const name = document.createElement('span');
                name.className = 'text-sm font-medium';
                name.textContent = room.name;

                nameDiv.appendChild(icon);
                nameDiv.appendChild(name);

                const joinBtn = document.createElement('button');
                joinBtn.innerHTML = 'üìπ';
                joinBtn.className = 'text-sm hover:bg-green-600 p-1 rounded';
                joinBtn.title = 'Join call room';
                joinBtn.onclick = () => window.location.href = `/chat/general?join-call=${room.slug}`;

                div.appendChild(nameDiv);
                div.appendChild(joinBtn);
                li.appendChild(div);
                callRoomsList.appendChild(li);
            });
        }

        // Load online users
        async function fetchOnlineUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    const users = await response.json();
                    renderOnlineUsersList(users);
                }
            } catch (error) {
                console.error('Error fetching online users:', error);
            }
        }

        function renderOnlineUsersList(users) {
            const onlineUsersList = document.getElementById('online-users-list');
            if (!onlineUsersList) return;

            onlineUsersList.innerHTML = '';

            // Filter to show only online users
            const onlineUsers = users.filter(user => user.is_online);

            if (onlineUsers.length === 0) {
                const emptyLi = document.createElement('li');
                emptyLi.className = 'text-sm text-gray-500 italic px-2';
                emptyLi.textContent = 'Geen online gebruikers';
                onlineUsersList.appendChild(emptyLi);
                return;
            }

            onlineUsers.forEach(user => {
                const li = document.createElement('li');
                li.setAttribute('data-username', user.username);

                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-700 transition duration-150';

                // Avatar
                const img = document.createElement('img');
                img.src = user.avatar_url || '/static/default-avatar.svg';
                img.className = 'w-6 h-6 rounded-full';
                img.alt = user.username;

                // Status dot (always green for online users)
                const statusDot = document.createElement('div');
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500';

                // Username
                const span = document.createElement('span');
                span.className = 'text-sm flex-1';
                span.textContent = user.username;

                div.appendChild(img);
                div.appendChild(statusDot);
                div.appendChild(span);
                li.appendChild(div);
                onlineUsersList.appendChild(li);
            });
        }

        // Modal functions
        function openCreateRoomModal() {
            alert('Ga naar een chat kamer om een nieuwe kamer aan te maken');
        }

        function openSettingsModal() {
            alert('Ga naar een chat kamer om instellingen te openen');
        }

        // Initial load
        initializeE2EEncryption();
        loadUsers();
        loadUserProfile();
        loadRooms();
        loadCallRooms();
        fetchOnlineUsers();

        // Refresh online users every 10 seconds
        setInterval(fetchOnlineUsers, 10000);

        // Initialize emoji picker
        window.addEventListener('load', () => {
            if (window.EmojiPicker) {
                new EmojiPicker(messageInput, document.getElementById('emoji-btn'));
            }
        });
    </script>
</body>
</html>
